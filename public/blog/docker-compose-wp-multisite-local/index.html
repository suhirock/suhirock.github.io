<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGデナシ</title>
    <link rel="stylesheet" href="/style.css" media="screen">
    <link rel="icon" type="image/png" href="https://avatars.githubusercontent.com/u/38547890?s=60&v=4">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NN1RDH0627"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-NN1RDH0627');
    </script>
</head>
<body>
    <header>
        <h1 class="site-title">LOGデナシ</h1>
        <div class="version">ver.8</div>
    </header>

    
<p>DockerでマルチサイトのWordPress環境をローカルに作成したかったので、chatGPTさんにdocker-compose.ymlを作成いただきました。</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">version</span><span>: &#39;</span><span style="color:#a3be8c;">3.9</span><span>&#39;
</span><span>
</span><span style="color:#bf616a;">services</span><span>:
</span><span>    </span><span style="color:#bf616a;">db</span><span>:
</span><span>        </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">my-mysql-container
</span><span>        </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">mysql:5.7
</span><span>        </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>            - </span><span style="color:#a3be8c;">db_data:/var/lib/mysql
</span><span>        </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">always
</span><span>        </span><span style="color:#bf616a;">environment</span><span>:
</span><span>            </span><span style="color:#bf616a;">MYSQL_ROOT_PASSWORD</span><span>: </span><span style="color:#a3be8c;">example_root_password
</span><span>            </span><span style="color:#bf616a;">MYSQL_DATABASE</span><span>: </span><span style="color:#a3be8c;">example_database_name
</span><span>            </span><span style="color:#bf616a;">MYSQL_USER</span><span>: </span><span style="color:#a3be8c;">example_user_name
</span><span>            </span><span style="color:#bf616a;">MYSQL_PASSWORD</span><span>: </span><span style="color:#a3be8c;">example_user_password
</span><span>
</span><span>    </span><span style="color:#bf616a;">wordpress</span><span>:
</span><span>        </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">my-wordpress-container
</span><span>        </span><span style="color:#bf616a;">depends_on</span><span>:
</span><span>            - </span><span style="color:#a3be8c;">db
</span><span>        </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">wordpress:5.7.2-php7.4-apache
</span><span>        </span><span style="color:#bf616a;">platform</span><span>: </span><span style="color:#a3be8c;">linux/arm64/v8
</span><span>        </span><span style="color:#bf616a;">ports</span><span>:
</span><span>            - &quot;</span><span style="color:#a3be8c;">8000:80</span><span>&quot;
</span><span>        </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">always
</span><span>        </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>            - </span><span style="color:#a3be8c;">./wp-content:/var/www/html/wp-content
</span><span>            - </span><span style="color:#a3be8c;">./config:/var/www/html/wp-config.php
</span><span>            - </span><span style="color:#a3be8c;">./uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
</span><span>        </span><span style="color:#bf616a;">environment</span><span>:
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_HOST</span><span>: </span><span style="color:#a3be8c;">my-mysql-container:3306
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_NAME</span><span>: </span><span style="color:#a3be8c;">example_database_name
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_USER</span><span>: </span><span style="color:#a3be8c;">example_user_name
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_PASSWORD</span><span>: </span><span style="color:#a3be8c;">example_user_password
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_CONFIG_EXTRA</span><span>: </span><span style="color:#b48ead;">|
</span><span style="color:#a3be8c;">                /* Enable Multisite */
</span><span style="color:#a3be8c;">                define(&#39;WP_ALLOW_MULTISITE&#39;, true);
</span><span style="color:#a3be8c;">                
</span><span style="color:#a3be8c;">                /* Multisite */
</span><span style="color:#a3be8c;">                define(&#39;MULTISITE&#39;, true);
</span><span style="color:#a3be8c;">                define(&#39;SUBDOMAIN_INSTALL&#39;, false);
</span><span style="color:#a3be8c;">                define(&#39;DOMAIN_CURRENT_SITE&#39;, &#39;localhost:8000&#39;);
</span><span style="color:#a3be8c;">                define(&#39;PATH_CURRENT_SITE&#39;, &#39;/&#39;);
</span><span style="color:#a3be8c;">                define(&#39;SITE_ID_CURRENT_SITE&#39;, 1);
</span><span style="color:#a3be8c;">                define(&#39;BLOG_ID_CURRENT_SITE&#39;, 1);
</span><span style="color:#a3be8c;">
</span><span style="color:#bf616a;">volumes</span><span>:
</span><span>    </span><span style="color:#bf616a;">db_data</span><span>:
</span></code></pre>
<p>Error establishing a database connectionとなりました。なんでやねんですね。<br />
やっていくうちに以下コードでローカルにマルチサイトしました。</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">version</span><span>: &#39;</span><span style="color:#a3be8c;">3.9</span><span>&#39;
</span><span>
</span><span style="color:#bf616a;">services</span><span>:
</span><span>    </span><span style="color:#bf616a;">db</span><span>:
</span><span>        </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">mysql:5.7
</span><span>        </span><span style="color:#bf616a;">platform</span><span>: </span><span style="color:#a3be8c;">linux/amd64
</span><span>        </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>            - </span><span style="color:#a3be8c;">db_data:/var/lib/mysql
</span><span>        </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">always
</span><span>        </span><span style="color:#bf616a;">environment</span><span>:
</span><span>            </span><span style="color:#bf616a;">MYSQL_ROOT_PASSWORD</span><span>: </span><span style="color:#a3be8c;">example_root_password
</span><span>            </span><span style="color:#bf616a;">MYSQL_DATABASE</span><span>: </span><span style="color:#a3be8c;">example_database_name
</span><span>            </span><span style="color:#bf616a;">MYSQL_USER</span><span>: </span><span style="color:#a3be8c;">example_user_name
</span><span>            </span><span style="color:#bf616a;">MYSQL_PASSWORD</span><span>: </span><span style="color:#a3be8c;">example_user_password
</span><span>
</span><span>    </span><span style="color:#bf616a;">wordpress</span><span>:
</span><span>        </span><span style="color:#bf616a;">depends_on</span><span>:
</span><span>            - </span><span style="color:#a3be8c;">db
</span><span>        </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">wordpress:5.7.2
</span><span>        </span><span style="color:#bf616a;">platform</span><span>: </span><span style="color:#a3be8c;">linux/amd64
</span><span>        </span><span style="color:#bf616a;">ports</span><span>:
</span><span>            - &#39;</span><span style="color:#a3be8c;">80:80</span><span>&#39;
</span><span>        </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">always
</span><span>        </span><span style="color:#bf616a;">environment</span><span>:
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_HOST</span><span>: </span><span style="color:#a3be8c;">db:3306
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_USER</span><span>: </span><span style="color:#a3be8c;">example_user_name
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_PASSWORD</span><span>: </span><span style="color:#a3be8c;">example_user_password
</span><span>            </span><span style="color:#bf616a;">WORDPRESS_DB_NAME</span><span>: </span><span style="color:#a3be8c;">example_database_name
</span><span>        </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>            - </span><span style="color:#a3be8c;">./html:/var/www/html/
</span><span style="color:#bf616a;">volumes</span><span>:
</span><span>    </span><span style="color:#bf616a;">db_data</span><span>:
</span></code></pre>
<p>個人的にハマりポイントは以下でした</p>
<ul>
<li>M2 Macでは Platform パラメータを追加すべし。インストールがコケてしまうぞ！</li>
<li>DBのユーザ名を変更すると docker volume prune でボリュームのキャッシュを削除しないとデータベースに反映されないことがあるぞ！</li>
<li>マルチサイトを作成する場合はWordPressのポートを "80:80" にしよう！ドメインのポート番号が使用できないエラーがでてしまうぞ！</li>
</ul>


<div class="backlink">
<a href="javascript:history.back();">前に戻る</a>
</div>


    <a href="https://suhirock.github.io">TOP</a> | <a href="https://suhirock.github.io/blog/">ログ</a> | <a href="https://suhirock.github.io/privacy/">プライバシー</a>

    <footer>
        <small>&copy;suhirock</small>
    </footer>
</body>
</html>